
![](images/iceslogo.png)

---
title: "VISA"
author: Adriana Villamor
date: April 2018
output: 
  html_document(toc= TRUE, toc_float=TRUE)
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```


# Herring (*Clupea harengus*) in subdivisions 25–29 and 32, excluding the Gulf of Riga (central Baltic Sea)

***

![](images/atlantic-herring.png)

[Link to latest advice](http://www.ices.dk/sites/pub/Publication%20Reports/Advice/2018/2018/her.27.25-2932.pdf)  
[Link to Standard Graphs page](https://standardgraphs.ices.dk/manage/ViewGraphsAndTables.aspx?key=9428)

***

# ICES stock advice

ICES advises that when the EU multiannual plan (MAP) is applied, catches in 2019 that correspond to the F ranges in the plan are between **115 591** tonnes and **192 787** tonnes. According to the MAP, catches higher than those corresponding to FMSY (**155 333** tonnes) can only be taken under conditions specified in the MAP, whilst the entire range is considered precautionary when applying the ICES advice rule. This advice applies to all catches from the stock, including those taken in Subdivision 28.1.

# Stock development over time
Spawning-stock biomass (SSB) decreased until 2001 and then increased, and it has been above MSY Btrigger since 2007. Fishing mortality (F) increased until 2000 and then decreased, remaining below FMSY between 2004 to 2014. F has been above FMSY since 2015. Recruitment in 2015 is estimated to be the highest of the whole time-series.


```{r cars, echo = FALSE, fig.height = 4, fig.width = 5, fig.align = "top"}
 library(htmlwidgets)
 library(dplyr)
 library(ggplot2)
 library(gridExtra)
 library(dygraphs)
 library(htmltools)
 data <- read.csv("herdata.csv")
 
 dyBarChart <- function(dygraph) {
  dyPlotter(dygraph = dygraph,
            name = "BarChart",
            path = system.file("examples/plotters/barchart.js",
                               package = "dygraphs"))
}
 
 catches <- data %>% select(Year, catches)
 catches$catches <- catches[, "catches"]/1000
 recruitment<- data %>% select(Year, low_recruitment, recruitment, high_recruitment)
 
 dygraph(catches, main = "Catches") %>% 
   dyRangeSelector()%>%
   dyOptions(colors = RColorBrewer::brewer.pal(3, "Set2"), drawGrid = FALSE,maxNumberWidth = 4)%>%
   dyAxis("y", label = "Catches in 1000 t")%>%
   dyBarChart()
 dygraph(recruitment, main = "Recruitment(age 0)") %>%
   dyRangeSelector()%>%
   # dyOptions(colors = RColorBrewer::brewer.pal(3, "Set2"))%>%
   dyAxis("y", label = "Recruitment in millions")%>%
   dyBarChart()
 

```
 
  
 
```{r, echo = FALSE, fig.height = 4, fig.width = 6, fig.align = "left"}
library(dygraphs)
library(htmlwidgets)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(dygraphs)

dyBarChart <- function(dygraph) {
  dyPlotter(dygraph = dygraph,
            name = "BarChart",
            path = system.file("examples/plotters/barchart.js",
                               package = "dygraphs"))
} 

F <- data %>% select(Year, low_F, F,high_F, FLim, Fpa, FMSY )
 dygraph(F, main = "F") %>% 
  dySeries(c("low_F", "F", "high_F"))%>%
   dyLimit(as.numeric(F[, 5]), color = "red")%>%
   dyRangeSelector()%>%
   dyOptions(colors = RColorBrewer::brewer.pal(3, "Set2"), 
             drawGrid= FALSE,maxNumberWidth = 4)%>%
   dyAxis("y", label = "F(15-80cm)")

SSB <- data %>% select(Year, low_SSB, SSB,high_SSB, Blim, Bpa, MSYBtrigger)
 dygraph(SSB, main = "SSB") %>%
  dySeries(c("low_SSB", "SSB", "high_SSB"))%>%
   dyLimit(as.numeric(F[, 5]), color = "red")%>%
   dyRangeSelector()%>%
   dyOptions(colors = RColorBrewer::brewer.pal(3, "Set2"),
             drawGrid= FALSE,maxNumberWidth = 4)%>%
   dyAxis("y", label = "SSB in 1000 t")

# p<- ggplot(data, aes(x = Year, y= F)) + geom_line(position = "stack")
#  p <- p + theme_bw()
#  c<- ggplotly(p)
#  q <- ggplot(data, aes(x = Year, y= SSB)) + geom_line(position = "stack")
#  q <- q + theme_bw()
#  d<- ggplotly(q)
#  subplot(c,d)

#Need to figure out how to order them, and make them all show up 
```

***  
# Stock and explotation status

ICES assesses that fishing pressure on the stock is above FMSY and below Fpa and Flim; spawning stock size is above MSY Btrigger, Bpa, and Blim.

```{r, echo = FALSE, fig.height = 2, fig.width = 8, fig.align = "center"}
library(icesSAG)
assessmentKey <- findAssessmentKey("her.27.25-2932", 2018)
table <- getStockStatusTable(assessmentKey)
plot(table)

library(DT)
datatable(data, extensions = c('Buttons','FixedColumns'),
          options = list(pageLength = 5, dom = 'Bfrtip',
            buttons = c('csv','excel','copy','print'),
            scrollX = TRUE,
            fixedColumns = TRUE))
```

***  
# Catch scenarios  


<br>
**Table 2** Herring in subdivisions 25–29 and 32, excluding the Gulf of Riga. Assumptions made for the interim year and in the forecast. Weights are in tonnes. Recruitment is in thousands.
<br>
```{r catchoptionsbasis, echo=FALSE}
library(knitr)
library(readr)
library(kableExtra)
dt <- read.csv("hercatchoptionsbasis.csv",header = T, row.names = 1)
# dt <- dt [,-1] 
kable(dt, "html")%>%kable_styling(position = "center", full_width = T, font_size = 12)%>%
  row_spec(0, bold = T, color = "black", background = "lightgrey", align = "c")%>%
  column_spec(1, width = "15em")%>%
  column_spec(4, width = "60em")%>%
  column_spec(3, width = "10em")
```
<br>

***

**Table 3** Herring in subdivisions 25–29 and 32, excluding the Gulf of Riga. Annual catch scenarios. All weights are in tonnes
```{r catchoptions, echo=FALSE}
library(knitr)
library(readr)
library(kableExtra)
dt <- read.csv("hercatchoptions.csv", header = T, row.names = 1)
# dt <- dt [,-1]
dt <- dt[complete.cases(dt),]
kable(dt, "html")%>%kable_styling(position = "center")%>%
  row_spec(0, bold = T, color = "black", background = "lightgrey")%>%
  column_spec(1, width = "60em")%>%
  group_rows("ICES advice basis",1,3) %>%
  group_rows("Other options",4,10)

```


```{r echo = FALSE, fig.height = 4, fig.width = 6, fig.align = "left"}
library(plotly)
catchoptions <- read.csv("herscenariosplot.csv")
labels <- catchoptions$Basis
labels <- as.character(labels)
p1 <- ggplot(catchoptions, aes(F))+
   geom_rect(xmin = -Inf, ymin = -Inf, xmax = 0.41, ymax = Inf,
             fill = "lightgreen", alpha=0.50)+theme_bw()+
   # geom_rect(xmin = 0.280, ymin = -Inf, xmax = 0.282, ymax = Inf,
   #           fill = "gold", alpha=0.50)+theme_bw()+
   geom_rect(xmin = 0.41, ymin = -Inf, xmax = 0.52, ymax = Inf,
             fill = "coral")+theme_bw()+
   geom_rect(xmin = 0.52, ymin = -Inf, xmax = Inf, ymax = Inf,
             fill = "brown1")+theme_bw()+
   #Bpa
   geom_hline(yintercept=600000, linetype="dashed", color = "red")+
   #Blim
   geom_hline(yintercept=430000, linetype="dashed", color = "black")+
   #fmsy
   geom_vline(xintercept = 0.22,
              color = "yellow", size=3)+
   #fpa
   geom_vline(xintercept = 0.41, linetype="dotted",
              color = "blue", size=0.5)+
   #flim
   geom_vline(xintercept = 0.52, linetype="dotted",
              color = "blue", size=0.5)+
   # geom_col(aes(y = Catch), width = 0.15)+
   geom_point(aes(y = Catch),size = 2, colour= "Red") +
   geom_line(aes(y = Catch),size = 0.5, colour= "Red")+
   geom_point(aes(y=SSB), size = 2, colour= "Blue")+
   geom_line(aes(y = SSB),size = 0.5, colour= "Blue")+
   scale_y_continuous("tonnes",sec.axis = sec_axis(~., name = "SSB"))+
   scale_x_continuous(breaks = catchoptions$F, labels = labels)+
   xlab("Catch scenarios for 2018")+
   ylab("tonnes")
p2 <- p1 + theme(axis.text.x = element_text(face="bold", color="Black",
                             size=10, angle=45))+
  theme(legend.text = element_text(colour="blue", size = 16, face = "bold"))

# p1 <- plot_ly(catchoptions, x= ~ F, y = ~ catches, type = 'scatter', mode= 'lines')%>%
#   add_trace(y = ~ SSB, type = 'scatter', mode = 'lines')%>%
#   layout(shapes = list(type= "rect", fillcolor = "green", opacity = 0.2,
#           line = list(color = "green", opacity = 0.2), x0 = -Inf, x1 = 50))
  


ggplotly(p2, width = 600, height = 300)

#little turn to avoid double values adding in the bars
catchoptions <- catchoptions[!duplicated(catchoptions[,c('F')]),]
labels <- catchoptions$Basis
labels <- as.character(labels)
p1 <- ggplot(catchoptions, aes(F))+
   geom_rect(xmin = -Inf, ymin = -Inf, xmax = 0.62, ymax = Inf,
             fill = "lightgreen", alpha=0.50)+theme_bw()+
   # geom_rect(xmin = 0.280, ymin = -Inf, xmax = 0.282, ymax = Inf,
   #           fill = "gold", alpha=0.50)+theme_bw()+
   geom_rect(xmin = 0.62, ymin = -Inf, xmax = 0.87, ymax = Inf,
             fill = "coral")+theme_bw()+
   geom_rect(xmin = 0.87, ymin = -Inf, xmax = Inf, ymax = Inf,
             fill = "brown1")+theme_bw()+
   geom_hline(yintercept=600000, linetype="dashed", color = "red")+
   geom_hline(yintercept=430000, linetype="dashed", color = "black")+
   geom_vline(xintercept = 0.22,
              color = "yellow", size=3)+
   geom_vline(xintercept = 0.41, linetype="dotted",
              color = "blue", size=0.5)+
   geom_vline(xintercept = 0.52, linetype="dotted",
              color = "blue", size=0.5)+
   geom_col(aes(y = Catch), width = 0.15)+
   # geom_point(aes(y = Catch),size = 2, colour= "Red") +
   # geom_line(aes(y = Catch),size = 0.5, colour= "Red")+
   geom_point(aes(y=SSB), size = 2, colour= "Blue")+
   geom_line(aes(y = SSB),size = 0.5, colour= "Blue")+
   scale_y_continuous("tonnes",sec.axis = sec_axis(~., name = "SSB"))+
   scale_x_continuous(breaks = catchoptions$F, labels = labels)+
   xlab("Catch scenarios for 2018")+
   ylab("tonnes")
 p2 <- p1 + theme(axis.text.x = element_text(face="bold", color="Black",
                            size=10, angle=45))+
   theme(legend.text = element_text(colour="blue", size = 16, face = "bold"))
 # p3<- p2+ guide_colorbar(title = "Spawning Stock Biomass", label= TRUE,barheight = )
# p3<- p2 + geom_hline(yintercept=45000, linetype="dashed", color = "red")+
#   geom_hline(yintercept=32000, linetype="dashed", color = "black")+
#   geom_vline(xintercept = 0.28,
#                 color = "yellow", size=3)+
#   geom_vline(xintercept = 0.62, linetype="dotted",
#                   color = "blue", size=0.5)+
#   geom_vline(xintercept = 0.87, linetype="dotted",
#                 color = "blue", size=0.5)



ggplotly(p2, width = 600, height = 300)
```

<br>
<!-- ![Catch scenarios plot](herscenariosplot.png) -->

```{r, out.width = "600px"}
knitr::include_graphics("herscenariosplot.png")

```



Herring in Subarea 4 and divisions 3.a and 7.d, autumn spawners. The intermediate year (2017) assumptions. Weights are in tonnes.
<br>
